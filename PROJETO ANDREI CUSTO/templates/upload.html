{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Despesas - Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados para a aplicação */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* cor de fundo mais suave */
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 16px 16px;
        }

        /* Estilos para o container de upload */
        .input-file-container input[type="file"] {
            display: none;
        }

        .input-file-container .input-file-trigger {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            padding: 2.5rem 1.5rem;
            border-radius: 1rem;
            border: 2px dashed #9ca3af;
            color: #4b5563;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
        }

        .input-file-container .input-file-trigger:hover {
            background-color: #f1f5f9;
            border-color: #6366f1; /* Cor primária do hover */
            color: #1f2937;
        }

        .input-file-container .file-return {
            color: #64748b;
            margin-top: 0.75rem;
            font-size: 0.875rem;
            text-align: left;
            word-wrap: break-word;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Estilo para a animação de carregamento */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        /* Estilos para a tela de carregamento em tela cheia */
        .full-screen-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(17, 24, 39, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }

        .full-screen-loader.active {
            opacity: 1;
            visibility: visible;
        }

        .full-screen-loader .spinner-lg {
            border: 8px solid rgba(255, 255, 255, 0.2);
            border-top: 8px solid #6366f1;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1s linear infinite;
        }

        /* Keyframes da animação de rotação */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Cabeçalho -->
    <header class="bg-white shadow-lg w-full">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center">
                <!-- Placeholder para a imagem do logo -->
                <img src="{% static 'acqua.jpeg' %}" alt="Logo do Instituto Acqua" class="h-10 w-auto rounded-lg shadow-md">
                <span class="ml-3 text-xl font-bold text-gray-800">Sistema de Custos</span>
            </div>
            <nav class="hidden sm:block">
                <ul class="flex space-x-6">
                    <li><a href="#" class="text-gray-600 hover:text-indigo-600 transition-colors duration-200 font-medium">Início</a></li>
                    <li><a href="#" class="text-gray-600 hover:text-indigo-600 transition-colors duration-200 font-medium">Sobre</a></li>
                    <li><a href="#" class="text-gray-600 hover:text-indigo-600 transition-colors duration-200 font-medium">Contato</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="flex-grow flex flex-col items-center p-4">
        <!-- Mensagens de feedback do Django -->
        {% if messages %}
        <div class="mb-6 w-full max-w-4xl">
            {% for message in messages %}
                <div class="px-4 py-3 rounded-lg text-sm font-medium
                    {% if message.tags == 'success' %} bg-green-100 text-green-700 {% endif %}
                    {% if message.tags == 'error' %} bg-red-100 text-red-700 {% endif %}
                    {% if message.tags == 'warning' %} bg-yellow-100 text-yellow-700 {% endif %}">
                    <i class="fa-solid {% if message.tags == 'success' %}fa-circle-check{% elif message.tags == 'error' %}fa-circle-xmark{% else %}fa-triangle-exclamation{% endif %} mr-2"></i> {{ message }}
                </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="container mx-auto flex flex-col lg:flex-row lg:items-start justify-center gap-8 p-4">
            
            <!-- Seção do Formulário de Upload (lado esquerdo em desktop) -->
            <div class="bg-white p-8 sm:p-10 rounded-2xl shadow-xl border border-gray-200 w-full lg:max-w-3xl transition-transform duration-300 hover:scale-[1.01]">
                <div class="text-center mb-6">
                    <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-800 flex items-center justify-center gap-3">
                        <i class="fa-solid fa-chart-line text-indigo-500"></i> Análise de Custos
                    </h1>
                    <p class="text-sm text-slate-500 mt-2">Carregue sua planilha para iniciar a análise.</p>
                </div>

                <form method="post" enctype="multipart/form-data" class="space-y-6" id="upload-form">
                    {% csrf_token %}

                    <div class="form-group">
                        <label for="id_name" class="block text-sm font-medium text-gray-700 mb-2">Nome da Análise</label>
                        <input type="text" name="name" id="id_name" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200" placeholder="Ex: Relatório de Janeiro">
                    </div>
                    
                    <div class="form-group">
                        <label for="id_arquivo_excel" class="block text-sm font-medium text-gray-700 mb-2">Selecione o Arquivo Excel</label>
                        <div class="input-file-container relative">
                            <input type="file" name="arquivo_excel" required="" id="id_arquivo_excel" class="w-full">
                            <label for="id_arquivo_excel" class="input-file-trigger">
                                <i class="fa-solid fa-cloud-arrow-up text-5xl text-gray-400 mb-3"></i>
                                <span id="file-name" class="text-gray-500 text-center font-medium">Clique para selecionar ou arraste um arquivo</span>
                            </label>
                            <p class="file-return"></p>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="submit" id="submit-button" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 shadow-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-magnifying-glass"></i> <span id="button-text">Analisar</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Seção de Análises Recentes (lado direito em desktop) -->
            <div class="bg-white p-8 sm:p-10 rounded-2xl shadow-xl border border-gray-200 w-full lg:max-w-3xl transition-transform duration-300 hover:scale-[1.01]">
                <div class="text-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-folder-open text-yellow-500"></i> Análises Recentes
                    </h2>
                    <p class="text-sm text-slate-500 mt-2">Clique em um arquivo para visualizar ou gerenciar a análise.</p>
                </div>

                <!-- Campo de busca -->
                <div class="relative mb-6">
                    <input type="text" id="file-search" placeholder="Buscar por nome ou ID..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>

                <!-- Lista de uploads com rolagem -->
                <div class="space-y-4 overflow-y-auto max-h-[800px] pr-2" id="file-list-container">
                    {% if uploaded_files %}
                        <ul class="space-y-4">
                            {% for file in uploaded_files %}
                                <li class="file-item bg-gray-50 p-4 rounded-xl flex flex-col sm:flex-row items-start sm:items-center justify-between shadow-sm transition-colors duration-200 hover:bg-indigo-50 hover:shadow-md" data-file-id="{{ file.file_id }}" data-file-name="{{ file.name }}">
                                    <div class="flex items-center mb-2 sm:mb-0">
                                        <i class="fa-solid fa-file-invoice text-indigo-500 mr-3 text-2xl"></i>
                                        <div>
                                            <p class="font-medium text-gray-800 file-name-display text-lg">
                                                {{ file.name }}
                                            </p>
                                            <p class="text-xs text-gray-500 mt-1">
                                                <span class="text-xs text-gray-400 mr-1">ID:</span><span class="text-gray-600 font-semibold">{{ file.file_id }}</span>
                                            </p>
                                            <p class="text-xs text-gray-500 mt-1">
                                                <span class="text-xs text-gray-400 mr-1">Criado em</span>{{ file.upload_date|date:"d/m/Y H:i" }}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2 w-full sm:w-auto mt-2 sm:mt-0">
                                        <button class="edit-btn text-gray-500 hover:text-blue-500 transition-colors duration-200 p-2 rounded-full hover:bg-gray-200" title="Editar nome">
                                            <i class="fa-solid fa-pen-to-square"></i>
                                        </button>
                                        <!-- Botão de Download com o ícone solicitado -->
                                        <a href="{% url 'download_file_view' file_id=file.file_id %}" class="flex-shrink-0 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded-full transition-colors duration-200 shadow-sm" title="Baixar arquivo">
                                            <i class="fa-solid fa-download"></i>
                                        </a>
                                        <a href="{% url 'analyze_data' file_id=file.file_id %}" class="flex-shrink-0 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold py-2 px-3 rounded-full transition-colors duration-200 shadow-sm">
                                            Ver Análise
                                        </a>
                                        <button class="delete-btn text-red-500 hover:text-red-700 transition-colors duration-200 p-2 rounded-full hover:bg-red-100" title="Excluir análise">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </button>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="text-center text-gray-500 py-8">
                            <i class="fa-solid fa-inbox-open text-4xl mb-3 text-gray-300"></i>
                            <p class="font-medium">Nenhum arquivo enviado ainda.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>
    
    <!-- Rodapé -->
    <footer class="bg-gray-900 text-gray-300 py-6 mt-auto shadow-inner">
        <div class="container mx-auto px-4 text-center">
            <p>Instituto Acqua &copy; 2025 Minha Aplicação. Todos os direitos reservados.</p>
            <p class="text-sm mt-2">Desenvolvido por <a href="#" class="text-indigo-400 hover:underline">FL SOFTWARES</a></p>
            </div>
    </footer>
    
    <!-- Modal de Confirmação de Exclusão -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="relative bg-white p-8 sm:p-10 rounded-2xl shadow-2xl max-w-sm w-full transform scale-100 transition-transform duration-300">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-3xl"></i>
                </div>
                <h3 class="text-2xl leading-6 font-bold text-gray-900 mt-4">Confirmar Exclusão</h3>
                <div class="mt-2 px-1 py-3">
                    <p class="text-sm text-gray-500">Tem certeza que deseja excluir a análise? Esta ação não pode ser desfeita.</p>
                </div>
                <div class="mt-6 space-y-3">
                    <button id="confirm-delete-btn" class="w-full py-3 bg-red-500 text-white text-base font-semibold rounded-lg shadow-sm hover:bg-red-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        Excluir
                    </button>
                    <button id="cancel-delete-btn" class="w-full py-3 bg-gray-200 text-gray-800 text-base font-semibold rounded-lg shadow-sm hover:bg-gray-300 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tela de Carregamento (Loading) -->
    <div id="loading-overlay" class="full-screen-loader hidden">
        <div class="spinner-lg"></div>
        <p class="mt-4 text-white text-xl font-semibold animate-pulse">Processando dados...</p>
    </div>

    <!-- JavaScript para interatividade -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('id_arquivo_excel');
            const fileReturn = document.querySelector('.file-return');
            const fileNameSpan = document.getElementById('file-name');
            const uploadForm = document.getElementById('upload-form');
            const submitButton = document.getElementById('submit-button');
            const fileSearchInput = document.getElementById('file-search');
            const fileListContainer = document.getElementById('file-list-container');
            const deleteModal = document.getElementById('delete-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            // Variável para armazenar o ID do arquivo a ser excluído
            let fileToDeleteId = null;

            // Lógica para mostrar o nome do arquivo selecionado
            if (fileInput && fileReturn) {
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length > 0) {
                        fileNameSpan.textContent = fileInput.files[0].name;
                        fileReturn.innerHTML = `<i class="fa-solid fa-circle-check text-green-500"></i>Arquivo selecionado com sucesso.`;
                    } else {
                        fileNameSpan.textContent = 'Clique para selecionar o arquivo';
                        fileReturn.textContent = '';
                    }
                });
            } else {
                console.error("Erro: Elemento de input de arquivo ou retorno não encontrado.");
            }

            // Adiciona o estado de carregamento ao botão de submit
            uploadForm.addEventListener('submit', (e) => {
                const nameInput = document.getElementById('id_name');
                if (fileInput.files.length > 0 && nameInput.value.trim() !== '') {
                    e.preventDefault();

                    // Mostra a tela de carregamento completa
                    loadingOverlay.classList.remove('hidden');
                    loadingOverlay.classList.add('active');

                    submitButton.disabled = true;
                    submitButton.classList.add('opacity-75', 'cursor-not-allowed');
                    submitButton.innerHTML = `<div class="loading-spinner"></div> <span class="font-semibold" id="button-text-loading">Analisando...</span>`;

                    // Simula um pequeno atraso antes de realmente enviar o formulário
                    setTimeout(() => {
                        uploadForm.submit();
                    }, 1000);
                }
            });

            // Adiciona a funcionalidade de busca
            if (fileSearchInput) {
                fileSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();

                    document.querySelectorAll('.file-item').forEach(item => {
                        const fileName = item.getAttribute('data-file-name')?.toLowerCase() || '';
                        const fileId = item.getAttribute('data-file-id')?.toLowerCase() || '';

                        if (fileName.includes(searchTerm) || fileId.includes(searchTerm)) {
                            item.classList.remove('hidden');
                        } else {
                            item.classList.add('hidden');
                        }
                    });
                });
            }

            // Lógica para edição e exclusão
            if(fileListContainer) {
                fileListContainer.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
    
                    const fileItem = target.closest('.file-item');
                    if (!fileItem) return;
    
                    const fileId = fileItem.getAttribute('data-file-id');
                    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    
                    // Lógica de edição
                    if (target.classList.contains('edit-btn')) {
                        const currentName = fileItem.getAttribute('data-file-name');
                        const newName = prompt("Insira o novo nome para a análise:", currentName);
    
                        if (newName !== null && newName.trim() !== "" && newName !== currentName) {
                            const formData = new FormData();
                            formData.append('new_name', newName);
                            formData.append('csrfmiddlewaretoken', csrfToken);
    
                            fetch(`/edit/${fileId}/`, {
                                method: 'POST',
                                body: formData,
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    fileItem.querySelector('.file-name-display').textContent = newName;
                                    fileItem.setAttribute('data-file-name', newName);
                                    console.log(data.message);
                                } else {
                                    console.error(data.message);
                                }
                            })
                            .catch(error => {
                                console.error("Erro na requisição:", error);
                            });
                        }
                    }
    
                    // Lógica de exclusão
                    if (target.classList.contains('delete-btn')) {
                        fileToDeleteId = fileId;
                        deleteModal.classList.remove('hidden');
                    }
                });
            }


            confirmDeleteBtn.addEventListener('click', () => {
                if (fileToDeleteId) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/delete/${fileToDeleteId}/`;

                    const csrfTokenInput = document.createElement('input');
                    csrfTokenInput.type = 'hidden';
                    csrfTokenInput.name = 'csrfmiddlewaretoken';
                    csrfTokenInput.value = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                    form.appendChild(csrfTokenInput);

                    document.body.appendChild(form);
                    form.submit();
                }
            });

            cancelDeleteBtn.addEventListener('click', () => {
                deleteModal.classList.add('hidden');
                fileToDeleteId = null;
            });
        });
    </script>
</body>
</html>
